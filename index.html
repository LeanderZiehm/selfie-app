<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Daily Face Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <meta name="theme-color" content="#000000" />
  <link rel="manifest" href="manifest.json" />

  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
    }

    body {
      background: black;
      overflow: hidden;
      touch-action: none;
    }

    #app {
      position: relative;
      width: 100vw;
      height: 100vh;
      background: black;
    }

    video,
    canvas,
    img {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    #overlay {
      opacity: 0.3;
      pointer-events: none;
    }

    #controls {
      position: absolute;
      bottom: 24px;
      width: 100%;
      display: flex;
      justify-content: center;
      z-index: 10;
    }

    #shutter {
      width: 72px;
      height: 72px;
      border-radius: 50%;
      border: 4px solid white;
      background: rgba(255, 255, 255, 0.2);
    }

    #shutter:active {
      transform: scale(0.95);
    }
  </style>
</head>

<body>
  <div id="app">
    <video id="camera" autoplay playsinline></video>
    <img id="overlay" />
    <canvas id="captureCanvas" hidden></canvas>

    <div id="controls">
      <button id="shutter"></button>
    </div>
  </div>

  <script>
    const video = document.getElementById("camera");
    const overlay = document.getElementById("overlay");
    const canvas = document.getElementById("captureCanvas");
    const shutter = document.getElementById("shutter");

    let db;

    // ---------- IndexedDB ----------
    function openDB() {
      return new Promise((resolve, reject) => {
        const request = indexedDB.open("FaceTrackerDB", 1);

        request.onupgradeneeded = e => {
          const db = e.target.result;
          db.createObjectStore("photos", { keyPath: "date" });
        };

        request.onsuccess = e => resolve(e.target.result);
        request.onerror = e => reject(e);
      });
    }

    function savePhoto(blob) {
      return new Promise(resolve => {
        const tx = db.transaction("photos", "readwrite");
        tx.objectStore("photos").put({
          date: new Date().toISOString().split("T")[0],
          blob
        });
        tx.oncomplete = resolve;
      });
    }

    function loadLastPhoto() {
      return new Promise(resolve => {
        const tx = db.transaction("photos", "readonly");
        const store = tx.objectStore("photos");
        const request = store.openCursor(null, "prev");

        request.onsuccess = e => {
          const cursor = e.target.result;
          resolve(cursor ? cursor.value.blob : null);
        };
      });
    }

    // ---------- Camera ----------
    async function startCamera() {
      const stream = await navigator.mediaDevices.getUserMedia({
        video: {
          facingMode: "user",
          width: { ideal: 1080 },
          height: { ideal: 1920 }
        },
        audio: false
      });

      video.srcObject = stream;
    }

    // ---------- Capture ----------
    shutter.onclick = async () => {
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;

      const ctx = canvas.getContext("2d");
      ctx.drawImage(video, 0, 0);

      canvas.toBlob(async blob => {
        await savePhoto(blob);
        overlay.src = URL.createObjectURL(blob);
      }, "image/jpeg", 0.95);
    };

    // ---------- Init ----------
    async function init() {
      db = await openDB();
      await startCamera();

      const lastPhoto = await loadLastPhoto();
      if (lastPhoto) {
        overlay.src = URL.createObjectURL(lastPhoto);
      }

      if ("serviceWorker" in navigator) {
        navigator.serviceWorker.register("service-worker.js");
      }
    }

    init();
  </script>
</body>
</html>
